@page "/thong-ke-tong-hop1"
@attribute [Authorize] // cơ chế phân quyền//


@using api.Models.QLKHCanBo
@inject ClientServices client // nhận dữ liệu//
@inject NotificationService notificationService // hiển thị thông báo cho người dùng//
@inject DialogService dialogService // hiển thị hộp thoại xem chi tiết sau khi thống kê//
@inject IJSRuntime jsRuntime // gọi JavaScript để xuất báo cáo //

<h3 style="
    color: #0b2e6f;
    font-weight: 800;
    font-size: 26px;
    text-transform: uppercase;
    text-align: center;
    letter-spacing: 1px;
    margin: 16px 0 24px;
">
    <i class="bx bx-bar-chart" style="margin-right:6px; font-size:22px;"></i>
    Thống kê NCKH tổng hợp
</h3>

<RadzenCard Style="margin-bottom:15px">
    <div class="row g-3">
        <div class="col-md-4">
            <RadzenDropDown Data="@LoaiThongKeList"
                            TValue="string" @*kiểu dữ liệu *@
                            TextProperty="Text"  @*thuộc tính hiện ra màn hình*@
                            ValueProperty="Value" @*thuộc tính giá trị thật được gán vào biến*@
                            @bind-Value="LoaiThongKe" @**@
                            Placeholder="Loại thống kê/báo cáo"
                            Style="width:100%" />
        </div>

        @if (LoaiThongKe == "count")
        {
            <div class="col-md-4">
                <RadzenDropDown Data="@NhomTheoList"
                                TValue="string"
                                TextProperty="Text"
                                ValueProperty="Value"
                                @bind-Value="NhomTheo"
                                Placeholder="Nhóm theo"
                                Style="width:100%" />
            </div>
        }

        @if (LoaiThongKe == "hours")
        {
            <div class="col-md-4">
                <RadzenDropDown Data="@NhomTheoGioList"
                                TValue="string"
                                TextProperty="Text"
                                ValueProperty="Value"
                                @bind-Value="NhomTheoGio"
                                Placeholder="Nhóm theo giờ NCKH"
                                Style="width:100%" />
            </div>
        }

        <div class="col-md-4">
            <RadzenDropDown Data="@NamHocList"
                            TValue="string"
                            @bind-Value="BoLoc.NamHoc"
                            AllowClear="true"
                            Placeholder="Thời gian (năm học)"
                            Style="width:100%" />
        </div>

        <div class="col-md-4">
            <RadzenDropDown Data="@CapDeTaiList"
                            TValue="int?"
                            @bind-Value="BoLoc.CapDeTai"
                            AllowClear="true"
                            Placeholder="Cấp đề tài"
                            Style="width:100%" />
        </div>

        <div class="col-md-4">
            <RadzenDropDown Data="@DonViChuTriList"
                            TValue="string"
                            @bind-Value="BoLoc.DonViChuTri"
                            AllowClear="true"
                            Placeholder="Đơn vị chủ trì"
                            Style="width:100%" />
        </div>

        <div class="col-md-4">
            <RadzenDropDown Data="@TrangThaiList"
                            TValue="int?"
                            @bind-Value="BoLoc.TrangThai"
                            AllowClear="true"
                            Placeholder="Trạng thái nhiệm vụ"
                            Style="width:100%" />
        </div>

        <div class="col-md-4">
            <RadzenDropDown Data="@XepLoaiList"
                            TValue="string"
                            @bind-Value="BoLoc.XepLoai"
                            AllowClear="true"
                            Placeholder="Kết quả đánh giá"
                            Style="width:100%" />
        </div>

        <div class="col-md-4">
            <RadzenDropDown Data="@LoaiNhiemVuList"
                            TValue="string"
                            @bind-Value="BoLoc.LoaiNhiemVu"
                            AllowClear="true"
                            Placeholder="Loại nhiệm vụ"
                            Style="width:100%" />
        </div>

        <div class="col-md-4">
            <RadzenDropDown Data="@LinhVucList"
                            TValue="int?"
                            @bind-Value="BoLoc.LinhVuc"
                            AllowClear="true"
                            Placeholder="Lĩnh vực nghiên cứu"
                            Style="width:100%" />
        </div>
    </div>
</RadzenCard>

<div style="margin-bottom:12px">
    <RadzenButton Text="Thống kê"
                  Icon="search"
                  ButtonStyle="ButtonStyle.Primary"
                  Click="@ThongKeAsync"
                  Style="margin-right:8px" />
    <RadzenButton Text="Xuất báo cáo"
                  Icon="download"
                  ButtonStyle="ButtonStyle.Secondary"
                  Disabled="@(!CoKetQua)"
                  Click="@XuatBaoCaoAsync" />
</div>

@if (LoaiThongKe == "progress" && TienDo != null)
{
    <RadzenCard Style="margin-bottom:12px">
        <div class="row text-center">
            <div class="col-md-4">
                <div style="font-weight:600">Hoàn thành</div>
                <div style="font-size:20px">@TienDo.HoanThanh</div>
            </div>
            <div class="col-md-4">
                <div style="font-weight:600">Đang thực hiện</div>
                <div style="font-size:20px">@TienDo.DangThucHien</div>
            </div>
            <div class="col-md-4">
                <div style="font-weight:600">Quá hạn</div>
                <div style="font-size:20px">@TienDo.QuaHan</div>
            </div>
        </div>
    </RadzenCard>
}
else if (LoaiThongKe == "hours")
{
    <RadzenDataGrid Data="@KetQuaGio"
                    TItem="ThongKeGioItem"
                    AllowPaging="true"
                    PageSize="10"
                    Responsive="true">
        <Columns>
            <RadzenDataGridColumn Property="DoiTuong" Title="Đối tượng" />
            <RadzenDataGridColumn Property="TongGio" Title="Tổng giờ NCKH" TextAlign="TextAlign.Center" />
            <RadzenDataGridColumn Property="SoBanGhi" Title="Số bản ghi" TextAlign="TextAlign.Center" />
        </Columns>
    </RadzenDataGrid>
}
else
{
    <RadzenDataGrid Data="@KetQua"
                    TItem="ThongKeKetQuaItem"
                    AllowPaging="true"
                    PageSize="10"
                    Responsive="true">
        <Columns>
            <RadzenDataGridColumn Property="Ten" Title="Nhóm thống kê" />
            <RadzenDataGridColumn Property="SoLuong" Title="Số lượng" TextAlign="TextAlign.Center" />
            <RadzenDataGridColumn Title="Chi tiết" Width="120px" TextAlign="TextAlign.Center">
                <Template Context="item">
                    <RadzenButton Text="Xem"
                                  Icon="visibility"
                                  Size="ButtonSize.Small"
                                  ButtonStyle="ButtonStyle.Info"
                                  Click="@(() => XemChiTiet(item))" />
                </Template>
            </RadzenDataGridColumn>
        </Columns>
    </RadzenDataGrid>
}

@code {
    const string ThongBaoKhongCoDuLieu = "Không có dữ liệu phù hợp";

    ThongKeFilter BoLoc = new();
    string LoaiThongKe = "count";@*mặc định được chọn là số lượng *@
    string NhomTheo = "NamHoc";
    string NhomTheoGio = "DonVi";

    List<tbDeTaiKHCanBo> DeTais = new();
    List<tbTongHopGioNCKH> TongHopGios = new();

    List<string> NamHocList = new();
    List<int> CapDeTaiList = new();
    List<string> DonViChuTriList = new();
    List<int> TrangThaiList = new();
    List<string> XepLoaiList = new();
    List<string> LoaiNhiemVuList = new();
    List<int> LinhVucList = new();

    List<ThongKeKetQuaItem> KetQua = new();
    List<ThongKeGioItem> KetQuaGio = new();
    ThongKeTienDo? TienDo;
    bool CoKetQua => KetQua.Count > 0 || KetQuaGio.Count > 0 || TienDo != null;

    List<ThongKeOption> LoaiThongKeList = new()
    {
        new() { Value = "count", Text = "Thống kê số lượng nhiệm vụ NCKH" },
        new() { Value = "progress", Text = "Thống kê tiến độ thực hiện" },
        new() { Value = "rate", Text = "Thống kê kết quả đánh giá/xếp loại" },
        new() { Value = "hours", Text = "Tổng giờ NCKH theo cá nhân/đơn vị" }
    };

    List<ThongKeOption> NhomTheoList = new()
    {
        new() { Value = "NamHoc", Text = "Theo năm học" },
        new() { Value = "CapDeTai", Text = "Theo cấp đề tài" },
        new() { Value = "LinhVuc", Text = "Theo lĩnh vực nghiên cứu" },
        new() { Value = "DonViChuTri", Text = "Theo đơn vị chủ trì" },
        new() { Value = "TrangThai", Text = "Theo trạng thái nhiệm vụ" },
        new() { Value = "LoaiNhiemVu", Text = "Theo loại nhiệm vụ" }
    };

    List<ThongKeOption> NhomTheoGioList = new()
    {
        new() { Value = "DonVi", Text = "Theo đơn vị" },
        new() { Value = "CanBo", Text = "Theo cá nhân" }
    };

    protected override async Task OnInitializedAsync()
    {
        try
        {
            DeTais = await client.apiSevices.GetAll<tbDeTaiKHCanBo>() ?? new();
            TongHopGios = await client.apiSevices.GetAll<tbTongHopGioNCKH>() ?? new();

            NamHocList = DeTais
                .Select(x => x.NamHoc)
                .Where(x => !string.IsNullOrWhiteSpace(x))
                .Distinct()
                .OrderBy(x => x)
                .ToList()!;

            CapDeTaiList = DeTais
                .Where(x => x.IdCapDeTai.HasValue)
                .Select(x => x.IdCapDeTai!.Value)
                .Distinct()
                .OrderBy(x => x)
                .ToList();

            DonViChuTriList = DeTais
                .Select(x => x.DonViChuTri)
                .Where(x => !string.IsNullOrWhiteSpace(x))
                .Distinct()
                .OrderBy(x => x)
                .ToList()!;

            TrangThaiList = DeTais
                .Where(x => x.IdTinhTrangDeTaiKHCB.HasValue)
                .Select(x => x.IdTinhTrangDeTaiKHCB!.Value)
                .Distinct()
                .OrderBy(x => x)
                .ToList();

            XepLoaiList = DeTais
                .Select(x => x.XepLoai)
                .Where(x => !string.IsNullOrWhiteSpace(x))
                .Distinct()
                .OrderBy(x => x)
                .ToList()!;

            LoaiNhiemVuList = DeTais
                .Select(x => x.LoaiDeTai)
                .Where(x => !string.IsNullOrWhiteSpace(x))
                .Distinct()
                .OrderBy(x => x)
                .ToList()!;

            LinhVucList = DeTais
                .Where(x => x.IdLinhVuc.HasValue)
                .Select(x => x.IdLinhVuc!.Value)
                .Distinct()
                .OrderBy(x => x)
                .ToList();
        }
        catch (Exception ex)
        {
            notificationService.Notify(
                Radzen.NotificationSeverity.Error,
                "Lỗi",
                ex.Message
            );
        }
    }

    async Task ThongKeAsync()@*hàm được gọi khi bấm nút thống kê*@
    {
        KetQua.Clear();@*reset kết quả cũ*@
        KetQuaGio.Clear();
        TienDo = null;

        if (LoaiThongKe == "hours")
        {
            var duLieuGio = TongHopGios.AsEnumerable();

            if (!string.IsNullOrWhiteSpace(BoLoc.NamHoc))
            {
                duLieuGio = duLieuGio.Where(x => x.NamHoc == BoLoc.NamHoc);
            }

            KetQuaGio = NhomTheoGio switch
            {
                "CanBo" => duLieuGio
                    .GroupBy(x => x.IdCanBo)
                    .Select(g => new ThongKeGioItem
                    {
                        DoiTuong = g.Key.HasValue ? $"Cán bộ {g.Key}" : "Chưa xác định",
                        TongGio = g.Sum(x => x.SoGioNCKH ?? 0),
                        SoBanGhi = g.Count()
                    })
                    .OrderByDescending(x => x.TongGio)
                    .ToList(),
                _ => duLieuGio
                    .GroupBy(x => x.IdDonVi)
                    .Select(g => new ThongKeGioItem
                    {
                        DoiTuong = g.Key.HasValue ? $"Đơn vị {g.Key}" : "Chưa xác định",
                        TongGio = g.Sum(x => x.SoGioNCKH ?? 0),
                        SoBanGhi = g.Count()
                    })
                    .OrderByDescending(x => x.TongGio)
                    .ToList()
            };

            if (KetQuaGio.Count == 0)
            {
                notificationService.Notify(Radzen.NotificationSeverity.Warning, "Thông báo", ThongBaoKhongCoDuLieu);
            }

            return;
        }

        var duLieu = ApplyFilters(DeTais).ToList();

        if (LoaiThongKe == "progress")
        {
            var now = DateOnly.FromDateTime(DateTime.Now);
            var hoanThanh = duLieu.Count(x => x.NgayNghiemThu != null);
            var dangThucHien = duLieu.Count(x => x.NgayNghiemThu == null && (x.HanHoanThanh == null || now <= x.HanHoanThanh));
            var quaHan = duLieu.Count(x => x.NgayNghiemThu == null && x.HanHoanThanh != null && now > x.HanHoanThanh);

            TienDo = new ThongKeTienDo
            {
                HoanThanh = hoanThanh,
                DangThucHien = dangThucHien,
                QuaHan = quaHan
            };

            if (hoanThanh + dangThucHien + quaHan == 0)
            {
                notificationService.Notify(Radzen.NotificationSeverity.Warning, "Thông báo", ThongBaoKhongCoDuLieu);
            }

            return;
        }

        if (LoaiThongKe == "rate")
        {
            KetQua = duLieu
                .GroupBy(x => x.XepLoai)
                .Select(g => new ThongKeKetQuaItem
                {
                    Key = g.Key,
                    Ten = string.IsNullOrWhiteSpace(g.Key) ? "Chưa xác định" : g.Key!,
                    SoLuong = g.Count()
                })
                .OrderByDescending(x => x.SoLuong)
                .ToList();
        }
        else
        {
            KetQua = NhomTheo switch
            {
                "CapDeTai" => duLieu
                    .GroupBy(x => x.IdCapDeTai)
                    .Select(g => new ThongKeKetQuaItem
                    {
                        Key = g.Key?.ToString(),
                        Ten = g.Key.HasValue ? $"Cấp đề tài {g.Key}" : "Chưa xác định",
                        SoLuong = g.Count()
                    })
                    .OrderBy(x => x.Ten)
                    .ToList(),
                "LinhVuc" => duLieu
                    .GroupBy(x => x.IdLinhVuc)
                    .Select(g => new ThongKeKetQuaItem
                    {
                        Key = g.Key?.ToString(),
                        Ten = g.Key.HasValue ? $"Lĩnh vực {g.Key}" : "Chưa xác định",
                        SoLuong = g.Count()
                    })
                    .OrderBy(x => x.Ten)
                    .ToList(),
                "DonViChuTri" => duLieu
                    .GroupBy(x => x.DonViChuTri)
                    .Select(g => new ThongKeKetQuaItem
                    {
                        Key = g.Key,
                        Ten = string.IsNullOrWhiteSpace(g.Key) ? "Chưa xác định" : g.Key!,
                        SoLuong = g.Count()
                    })
                    .OrderBy(x => x.Ten)
                    .ToList(),
                "TrangThai" => duLieu
                    .GroupBy(x => x.IdTinhTrangDeTaiKHCB)
                    .Select(g => new ThongKeKetQuaItem
                    {
                        Key = g.Key?.ToString(),
                        Ten = g.Key.HasValue ? $"Trạng thái {g.Key}" : "Chưa xác định",
                        SoLuong = g.Count()
                    })
                    .OrderBy(x => x.Ten)
                    .ToList(),
                "LoaiNhiemVu" => duLieu
                    .GroupBy(x => x.LoaiDeTai)
                    .Select(g => new ThongKeKetQuaItem
                    {
                        Key = g.Key,
                        Ten = string.IsNullOrWhiteSpace(g.Key) ? "Chưa xác định" : g.Key!,
                        SoLuong = g.Count()
                    })
                    .OrderBy(x => x.Ten)
                    .ToList(),
                _ => duLieu
                    .GroupBy(x => x.NamHoc)
                    .Select(g => new ThongKeKetQuaItem
                    {
                        Key = g.Key,
                        Ten = string.IsNullOrWhiteSpace(g.Key) ? "Chưa xác định" : g.Key!,
                        SoLuong = g.Count()
                    })
                    .OrderBy(x => x.Ten)
                    .ToList()
            };
        }

        if (KetQua.Count == 0)
        {
            notificationService.Notify(Radzen.NotificationSeverity.Warning, "Thông báo", ThongBaoKhongCoDuLieu);
        }

        await Task.CompletedTask;
    }

    void XemChiTiet(ThongKeKetQuaItem item)
    {
        var duLieu = ApplyFilters(DeTais).ToList();

        if (LoaiThongKe == "rate")
        {
            duLieu = string.IsNullOrWhiteSpace(item.Key)
                ? duLieu.Where(x => string.IsNullOrWhiteSpace(x.XepLoai)).ToList()
                : duLieu.Where(x => x.XepLoai == item.Key).ToList();
        }
        else
        {
            switch (NhomTheo)
            {
                case "CapDeTai":
                    duLieu = string.IsNullOrWhiteSpace(item.Key)
                        ? duLieu.Where(x => !x.IdCapDeTai.HasValue).ToList()
                        : duLieu.Where(x => x.IdCapDeTai?.ToString() == item.Key).ToList();
                    break;
                case "LinhVuc":
                    duLieu = string.IsNullOrWhiteSpace(item.Key)
                        ? duLieu.Where(x => !x.IdLinhVuc.HasValue).ToList()
                        : duLieu.Where(x => x.IdLinhVuc?.ToString() == item.Key).ToList();
                    break;
                case "DonViChuTri":
                    duLieu = string.IsNullOrWhiteSpace(item.Key)
                        ? duLieu.Where(x => string.IsNullOrWhiteSpace(x.DonViChuTri)).ToList()
                        : duLieu.Where(x => x.DonViChuTri == item.Key).ToList();
                    break;
                case "TrangThai":
                    duLieu = string.IsNullOrWhiteSpace(item.Key)
                        ? duLieu.Where(x => !x.IdTinhTrangDeTaiKHCB.HasValue).ToList()
                        : duLieu.Where(x => x.IdTinhTrangDeTaiKHCB?.ToString() == item.Key).ToList();
                    break;
                case "LoaiNhiemVu":
                    duLieu = string.IsNullOrWhiteSpace(item.Key)
                        ? duLieu.Where(x => string.IsNullOrWhiteSpace(x.LoaiDeTai)).ToList()
                        : duLieu.Where(x => x.LoaiDeTai == item.Key).ToList();
                    break;
                default:
                    duLieu = string.IsNullOrWhiteSpace(item.Key)
                        ? duLieu.Where(x => string.IsNullOrWhiteSpace(x.NamHoc)).ToList()
                        : duLieu.Where(x => x.NamHoc == item.Key).ToList();
                    break;
            }
        }

        dialogService.Open<ThongKeTongHopChiTietDialog>(
            $"Danh sách nhiệm vụ ({item.Ten})",
            new Dictionary<string, object>
            {
                { "DanhSach", duLieu }
            },
            new DialogOptions
            {
                Width = "1000px",
                Height = "650px",
                Resizable = true
            });
    }

    async Task XuatBaoCaoAsync()
    {
        if (!CoKetQua)
        {
            return;
        }

        var csvBuilder = new System.Text.StringBuilder();

        if (LoaiThongKe == "progress" && TienDo != null)
        {
            csvBuilder.AppendLine("ChiTiet,SoLuong");
            csvBuilder.AppendLine($"{EscapeCsv("Hoàn thành")},{TienDo.HoanThanh}");
            csvBuilder.AppendLine($"{EscapeCsv("Đang thực hiện")},{TienDo.DangThucHien}");
            csvBuilder.AppendLine($"{EscapeCsv("Quá hạn")},{TienDo.QuaHan}");
        }
        else if (LoaiThongKe == "hours")
        {
            csvBuilder.AppendLine("DoiTuong,TongGio,SoBanGhi");
            foreach (var item in KetQuaGio)
            {
                csvBuilder.AppendLine($"{EscapeCsv(item.DoiTuong)},{item.TongGio},{item.SoBanGhi}");
            }
        }
        else
        {
            csvBuilder.AppendLine("NhomThongKe,SoLuong");
            foreach (var item in KetQua)
            {
                csvBuilder.AppendLine($"{EscapeCsv(item.Ten)},{item.SoLuong}");
            }
        }

        await jsRuntime.InvokeVoidAsync("downloadFileFromText", $"thong-ke-{LoaiThongKe}.csv", csvBuilder.ToString());
    }

    static string EscapeCsv(string? value)
    {
        if (string.IsNullOrEmpty(value))
        {
            return "\"\"";
        }

        var escaped = value.Replace("\"", "\"\"");
        return $"\"{escaped}\"";
    }

    static IEnumerable<tbDeTaiKHCanBo> ApplyFilters(IEnumerable<tbDeTaiKHCanBo> data, ThongKeFilter boLoc)
    {
        var query = data;

        if (!string.IsNullOrWhiteSpace(boLoc.NamHoc))
        {
            query = query.Where(x => x.NamHoc == boLoc.NamHoc);
        }

        if (boLoc.CapDeTai.HasValue)
        {
            query = query.Where(x => x.IdCapDeTai == boLoc.CapDeTai);
        }

        if (!string.IsNullOrWhiteSpace(boLoc.DonViChuTri))
        {
            query = query.Where(x => !string.IsNullOrWhiteSpace(x.DonViChuTri)
                && x.DonViChuTri.Contains(boLoc.DonViChuTri, StringComparison.CurrentCultureIgnoreCase));
        }

        if (boLoc.TrangThai.HasValue)
        {
            query = query.Where(x => x.IdTinhTrangDeTaiKHCB == boLoc.TrangThai);
        }

        if (!string.IsNullOrWhiteSpace(boLoc.XepLoai))
        {
            query = query.Where(x => x.XepLoai == boLoc.XepLoai);
        }

        if (!string.IsNullOrWhiteSpace(boLoc.LoaiNhiemVu))
        {
            query = query.Where(x => x.LoaiDeTai == boLoc.LoaiNhiemVu);
        }

        if (boLoc.LinhVuc.HasValue)
        {
            query = query.Where(x => x.IdLinhVuc == boLoc.LinhVuc);
        }

        return query;
    }

    IEnumerable<tbDeTaiKHCanBo> ApplyFilters(IEnumerable<tbDeTaiKHCanBo> data)
        => ApplyFilters(data, BoLoc);

    class ThongKeFilter
    {
        public string? NamHoc { get; set; }
        public int? CapDeTai { get; set; }
        public string? DonViChuTri { get; set; }
        public int? TrangThai { get; set; }
        public string? XepLoai { get; set; }
        public string? LoaiNhiemVu { get; set; }
        public int? LinhVuc { get; set; }
    }

    class ThongKeOption
    {
        public string Value { get; set; } = string.Empty;
        public string Text { get; set; } = string.Empty;
    }

    class ThongKeKetQuaItem
    {
        public string? Key { get; set; }
        public string Ten { get; set; } = string.Empty;
        public int SoLuong { get; set; }
    }

    class ThongKeGioItem
    {
        public string DoiTuong { get; set; } = string.Empty;
        public int TongGio { get; set; }
        public int SoBanGhi { get; set; }
    }

    class ThongKeTienDo
    {
        public int HoanThanh { get; set; }
        public int DangThucHien { get; set; }
        public int QuaHan { get; set; }
    }
}