@page "/thong-ke-ket-qua-danh-gia"
@attribute [Authorize]

@using api.Models.QLKHCanBo
@inject ClientServices client
@inject NotificationService notificationService
@inject DialogService dialogService

<h3 style="
    color: #0b2e6f;
    font-weight: 800;
    font-size: 26px;
    text-transform: uppercase;
    text-align: center;
    letter-spacing: 1px;
    margin: 16px 0 24px;
">
    <i class="bx bx-badge-check" style="margin-right:6px; font-size:22px;"></i>
    Thống kê kết quả đánh giá nhiệm vụ NCKH
</h3>




<!-- =========================
     BỘ LỌC
========================= -->
<RadzenCard Style="margin-bottom:15px">
    <div class="row g-3">
        <!-- NĂM HỌC -->
        <div class="col-md-4">
            <RadzenDropDown Data="@NamHocList"
                            TValue="string"
                            @bind-Value="NamHoc"
                            Placeholder="Năm học (tùy chọn)"
                            AllowClear="true"
                            Style="width:100%" />
        </div>
    </div>
</RadzenCard>

<RadzenButton Text="Thống kê"
              Icon="search"
              ButtonStyle="ButtonStyle.Primary"
              Click="@ThongKe"
              Style="margin-bottom:10px" />

<!-- =========================
     KẾT QUẢ
========================= -->
<RadzenDataGrid Data="@KetQua"
                TItem="ThongKeDanhGiaVM"
                AllowPaging="true"
                PageSize="10"
                Responsive="true">
    <Columns>

        <RadzenDataGridColumn Property="XepLoai"
                              Title="Kết quả đánh giá" />

        <RadzenDataGridColumn Property="SoLuong"
                              Title="Số lượng nhiệm vụ"
                              TextAlign="TextAlign.Center" />

        <!-- XEM CHI TIẾT -->
        <RadzenDataGridColumn Title="Chi tiết"
                              Width="120px"
                              TextAlign="TextAlign.Center">
            <Template Context="item">
                <RadzenButton Text="Xem"
                              Icon="visibility"
                              Size="ButtonSize.Small"
                              ButtonStyle="ButtonStyle.Info"
                              Click="@(() => XemChiTiet(item.XepLoai))" />
            </Template>
        </RadzenDataGridColumn>

    </Columns>
</RadzenDataGrid>

@code {

    // =========================
    // DỮ LIỆU GỐC
    // =========================
    List<tbDeTaiKHCanBo> DeTais = new();

    // =========================
    // BỘ LỌC
    // =========================
    string? NamHoc;
    List<string> NamHocList = new();

    // =========================
    // KẾT QUẢ
    // =========================
    List<ThongKeDanhGiaVM> KetQua = new();

    // =========================
    // LOAD DATA
    // =========================
    protected override async Task OnInitializedAsync()
    {
        try
        {
            DeTais = await client.apiSevices.GetAll<tbDeTaiKHCanBo>()
                      ?? new List<tbDeTaiKHCanBo>();

            NamHocList = DeTais
                .Where(x => !string.IsNullOrWhiteSpace(x.NamHoc))
                .Select(x => x.NamHoc!)
                .Distinct()
                .OrderBy(x => x)
                .ToList();
        }
        catch (Exception ex)
        {
            notificationService.Notify(
                Radzen.NotificationSeverity.Error,
                "Lỗi",
                ex.Message
            );
        }
    }

    // =========================
    // THỐNG KÊ THEO XẾP LOẠI
    // =========================
    void ThongKe()
    {
        var data = DeTais
            .Where(x => string.IsNullOrWhiteSpace(NamHoc) || x.NamHoc == NamHoc)
            .Where(x => !string.IsNullOrWhiteSpace(x.XepLoai));

        KetQua = data
            .GroupBy(x => x.XepLoai!)
            .Select(g => new ThongKeDanhGiaVM
            {
                XepLoai = g.Key,
                SoLuong = g.Count()
            })
            .OrderByDescending(x => x.SoLuong)
            .ToList();
    }

    // =========================
    // XEM CHI TIẾT
    // =========================
    void XemChiTiet(string xepLoai)
    {
        var danhSach = DeTais
            .Where(x => x.XepLoai == xepLoai)
            .Where(x => string.IsNullOrWhiteSpace(NamHoc) || x.NamHoc == NamHoc)
            .ToList();

        dialogService.Open<ThongKeDanhGiaChiTietDialog>(
            $"Danh sách đề tài - {xepLoai}",
            new Dictionary<string, object>
            {
                { "DanhSach", danhSach }
            },
            new DialogOptions
            {
                Width = "900px",
                Height = "600px",
                Resizable = true
            });
    }

    // =========================
    // VIEW MODEL
    // =========================
    class ThongKeDanhGiaVM
    {
        public string XepLoai { get; set; } = string.Empty;
        public int SoLuong { get; set; }
    }
}
