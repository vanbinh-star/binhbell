@page "/thong-ke-tien-do"
@attribute [Authorize]

@using api.Models.QLKHCanBo
@inject ApiServices apiServices
@inject NotificationService notificationService
@inject DialogService dialogService

<RadzenCard Style="padding:16px">
    <h4 style="
    color:#0d2c6c;
    font-weight:700;
    text-transform:uppercase;
    text-align:center;
    margin-bottom:20px;">
        <i class="bx bx-timer"></i>
        Thống kê tiến độ đề tài NCKH
    </h4>


    @if (isLoading)
    {
        <p>Đang tải dữ liệu...</p>
    }
    else
    {
        <!-- TIẾN ĐỘ TỔNG -->
        <RadzenProgressBar Value="@tienDo.PhanTramHoanThanh"
                           ShowValue="true"
                           Unit="%"
                           Style="height:22px" />

        <!-- CHI TIẾT -->
        <div class="row mt-3 text-center">

            <div class="col-md-4">
                🟢
                <a href="javascript:void(0)"
                   @onclick="() => XemChiTiet(LoaiTienDo.HoanThanh)">
                    Hoàn thành: <b>@tienDo.HoanThanh</b>
                </a>
            </div>

            <div class="col-md-4">
                🟡
                <a href="javascript:void(0)"
                   @onclick="() => XemChiTiet(LoaiTienDo.DangThucHien)">
                    Đang thực hiện: <b>@tienDo.DangThucHien</b>
                </a>
            </div>

            <div class="col-md-4">
                🔴
                <a href="javascript:void(0)"
                   @onclick="() => XemChiTiet(LoaiTienDo.QuaHan)">
                    Quá hạn: <b>@tienDo.QuaHan</b>
                </a>
            </div>

        </div>
    }
</RadzenCard>

@code {

    // =========================
    // DATA
    // =========================
    bool isLoading = true;
    List<tbDeTaiKHCanBo> DeTais = new();
    ThongKeTienDoVM tienDo = new();

    // =========================
    // LOAD DATA
    // =========================
    protected override async Task OnInitializedAsync()
    {
        try
        {
            DeTais = await apiServices.GetAll<tbDeTaiKHCanBo>()
                      ?? new List<tbDeTaiKHCanBo>();

            TinhTienDoTheoTinhTrang(DeTais);
        }
        catch (Exception ex)
        {
            notificationService.Notify(
                NotificationSeverity.Error,
                "Lỗi",
                ex.Message,
                4000);
        }
        finally
        {
            isLoading = false;
        }
    }

    // =========================
    // THỐNG KÊ TIẾN ĐỘ
    // THEO IdTinhTrangDeTaiKHCB
    // =========================
    void TinhTienDoTheoTinhTrang(List<tbDeTaiKHCanBo> list)
    {
        // ⚠️ ĐỔI ID CHO ĐÚNG DANH MỤC CỦA BẠN
        int[] HOAN_THANH = { 3 };
        int[] DANG_THUC_HIEN = { 1 };
        int[] QUA_HAN = { 2 };

        tienDo.HoanThanh = list.Count(x =>
            x.IdTinhTrangDeTaiKHCB.HasValue &&
            HOAN_THANH.Contains(x.IdTinhTrangDeTaiKHCB.Value));

        tienDo.DangThucHien = list.Count(x =>
            x.IdTinhTrangDeTaiKHCB.HasValue &&
            DANG_THUC_HIEN.Contains(x.IdTinhTrangDeTaiKHCB.Value));

        tienDo.QuaHan = list.Count(x =>
            x.IdTinhTrangDeTaiKHCB.HasValue &&
            QUA_HAN.Contains(x.IdTinhTrangDeTaiKHCB.Value));
    }

    // =========================
    // XEM CHI TIẾT
    // =========================
    void XemChiTiet(LoaiTienDo loai)
    {
        int[] HOAN_THANH = { 3 };
        int[] DANG_THUC_HIEN = { 1 };
        int[] QUA_HAN = { 2 };

        int[] ids = loai switch
        {
            LoaiTienDo.HoanThanh => HOAN_THANH,
            LoaiTienDo.DangThucHien => DANG_THUC_HIEN,
            LoaiTienDo.QuaHan => QUA_HAN,
            _ => Array.Empty<int>()
        };

        var danhSach = DeTais
            .Where(x => x.IdTinhTrangDeTaiKHCB.HasValue
                     && ids.Contains(x.IdTinhTrangDeTaiKHCB.Value))
            .ToList();

        dialogService.Open<ThongKeTienDoChiTietDialog>(
            "Danh sách đề tài",
            new Dictionary<string, object>
            {
                { "DanhSach", danhSach }
            },
            new DialogOptions
            {
                Width = "900px",
                Height = "600px",
                Resizable = true
            });
    }

    // =========================
    // ENUM + VIEW MODEL
    // =========================
    enum LoaiTienDo
    {
        HoanThanh,
        DangThucHien,
        QuaHan
    }

    class ThongKeTienDoVM
    {
        public int HoanThanh { get; set; }
        public int DangThucHien { get; set; }
        public int QuaHan { get; set; }

        public int Tong => HoanThanh + DangThucHien + QuaHan;

        public int PhanTramHoanThanh =>
            Tong == 0 ? 0 : (int)Math.Round((double)HoanThanh / Tong * 100);
    }
}
